<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thumbnail Builder - Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css?v=2.0.1">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        .admin-container {
            min-height: 100vh;
            background: #0a0a0a;
            color: #fff;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(20,20,30,0.8);
        }
        .admin-title {
            font-family: 'Outfit', sans-serif;
            font-size: 24px;
            font-weight: 600;
        }
        .admin-title span {
            color: #ff6b35;
        }
        .admin-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .admin-user-email {
            color: #888;
        }
        .btn-logout {
            padding: 8px 16px;
            background: rgba(255,100,100,0.1);
            border: 1px solid rgba(255,100,100,0.3);
            color: #ff6b6b;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-logout:hover {
            background: rgba(255,100,100,0.2);
        }
        .admin-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: rgba(30,30,40,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 24px;
        }
        .stat-label {
            color: #888;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 36px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
        }
        .stat-value.pending { color: #f7c531; }
        .stat-value.approved { color: #27ca40; }
        .stat-value.suspended { color: #ff5f56; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 20px;
            font-weight: 600;
        }
        .tabs {
            display: flex;
            gap: 8px;
        }
        .tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 14px;
        }
        .tab.active {
            background: #ff6b35;
            border-color: #ff6b35;
            color: #fff;
        }
        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }
        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(30,30,40,0.8);
            border-radius: 12px;
            overflow: hidden;
        }
        .users-table th {
            text-align: left;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
            color: #888;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .users-table td {
            padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .users-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }
        .user-email {
            font-weight: 500;
        }
        .user-name {
            color: #888;
            font-size: 13px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-badge.pending {
            background: rgba(247,197,49,0.1);
            color: #f7c531;
        }
        .status-badge.approved {
            background: rgba(39,202,64,0.1);
            color: #27ca40;
        }
        .status-badge.suspended {
            background: rgba(255,95,86,0.1);
            color: #ff5f56;
        }
        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255,107,53,0.1);
            color: #ff6b35;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .btn-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-approve {
            background: rgba(39,202,64,0.1);
            color: #27ca40;
            border: 1px solid rgba(39,202,64,0.3);
        }
        .btn-approve:hover {
            background: rgba(39,202,64,0.2);
        }
        .btn-reject {
            background: rgba(255,95,86,0.1);
            color: #ff5f56;
            border: 1px solid rgba(255,95,86,0.3);
        }
        .btn-reject:hover {
            background: rgba(255,95,86,0.2);
        }
        .btn-suspend {
            background: rgba(255,150,50,0.1);
            color: #ff9632;
            border: 1px solid rgba(255,150,50,0.3);
        }
        .btn-suspend:hover {
            background: rgba(255,150,50,0.2);
        }
        .btn-reactivate {
            background: rgba(100,150,255,0.1);
            color: #6496ff;
            border: 1px solid rgba(100,150,255,0.3);
        }
        .btn-reactivate:hover {
            background: rgba(100,150,255,0.2);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            color: #888;
            margin-bottom: 8px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #27ca40; }
        .toast.error { background: #ff5f56; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .admin-main { padding: 20px; }
            .users-table { font-size: 14px; }
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <header class="admin-header">
            <a href="/" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="tbPlayGradientAdm" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#8B5CF6"/>
                            <stop offset="100%" style="stop-color:#3B82F6"/>
                        </linearGradient>
                    </defs>
                    <rect x="0" y="0" width="32" height="32" rx="8" fill="url(#tbPlayGradientAdm)"/>
                    <path d="M12 8L24 16L12 24V8Z" fill="white"/>
                    <circle cx="26" cy="6" r="2" fill="#FFD700"/>
                </svg>
                <div class="admin-title">
                    <span style="color:#fff">Thumbnail</span><span style="color:#8B5CF6">Builder</span><span style="color:#6B7280;font-size:0.7em">.app</span> <span>Admin</span>
                </div>
            </a>
            <div class="admin-user">
                <a href="/create-v3.html" style="color: #8B5CF6; text-decoration: none; margin-right: 16px; padding: 8px 16px; border: 1px solid #8B5CF6; border-radius: 6px;">Create</a>
                <span class="admin-user-email" id="admin-email"></span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </header>

        <main class="admin-main">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Pending Approval</div>
                    <div class="stat-value pending" id="stat-pending">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Approved Users</div>
                    <div class="stat-value approved" id="stat-approved">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Suspended</div>
                    <div class="stat-value suspended" id="stat-suspended">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="stat-total">-</div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="section-header">
                <h2 class="section-title">User Management</h2>
                <div class="tabs">
                    <button class="tab active" data-filter="all">All</button>
                    <button class="tab" data-filter="pending">Pending</button>
                    <button class="tab" data-filter="approved">Approved</button>
                    <button class="tab" data-filter="suspended">Suspended</button>
                </div>
            </div>

            <div id="users-container">
                <div class="loading">Loading users...</div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api/auth';
        let allUsers = [];
        let currentFilter = 'all';

        // XSS Prevention: Escape HTML entities
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Check auth and admin role
        async function checkAuth() {
            const token = localStorage.getItem('tb_token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }

            try {
                const res = await fetch(API_BASE + '/me', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) {
                    throw new Error('Auth failed');
                }

                const data = await res.json();
                if (data.user.role !== 'admin') {
                    alert('Access denied. Admin only.');
                    window.location.href = '/index.html';
                    return false;
                }

                document.getElementById('admin-email').textContent = data.user.email;
                return true;
            } catch (err) {
                localStorage.removeItem('tb_token');
                window.location.href = '/login.html';
                return false;
            }
        }

        // Load all users
        async function loadUsers() {
            try {
                const token = localStorage.getItem('tb_token');
                const res = await fetch(API_BASE + '/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) throw new Error('Failed to load users');

                const data = await res.json();
                allUsers = data.users;
                updateStats();
                renderUsers();
            } catch (err) {
                showToast('Failed to load users', 'error');
            }
        }

        // Update stats
        function updateStats() {
            const pending = allUsers.filter(u => u.status === 'pending').length;
            const approved = allUsers.filter(u => u.status === 'approved').length;
            const suspended = allUsers.filter(u => u.status === 'suspended').length;

            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-approved').textContent = approved;
            document.getElementById('stat-suspended').textContent = suspended;
            document.getElementById('stat-total').textContent = allUsers.length;
        }

        // Render users table
        function renderUsers() {
            const container = document.getElementById('users-container');
            let filtered = allUsers;

            if (currentFilter !== 'all') {
                filtered = allUsers.filter(u => u.status === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No users found</h3>
                        <p>No ${currentFilter === 'all' ? '' : currentFilter + ' '}users to display.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(user => `
                            <tr>
                                <td>
                                    <div class="user-email">${escapeHtml(user.email)}</div>
                                    <div class="user-name">${escapeHtml(user.name) || 'No name'}</div>
                                </td>
                                <td>
                                    ${user.role === 'admin' ? '<span class="role-badge">Admin</span>' : 'User'}
                                </td>
                                <td>
                                    <span class="status-badge ${escapeHtml(user.status)}">${escapeHtml(user.status)}</span>
                                </td>
                                <td>${formatDate(user.created_at)}</td>
                                <td>
                                    <div class="action-buttons">
                                        ${getActionButtons(user)}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Get action buttons based on user status
        function getActionButtons(user) {
            if (user.role === 'admin') {
                return '<span style="color:#666">-</span>';
            }

            if (user.status === 'pending') {
                return `
                    <button class="btn-action btn-approve" onclick="approveUser('${user.id}')">Approve</button>
                    <button class="btn-action btn-reject" onclick="rejectUser('${user.id}')">Reject</button>
                `;
            }

            if (user.status === 'approved') {
                return `
                    <button class="btn-action btn-suspend" onclick="suspendUser('${user.id}')">Suspend</button>
                `;
            }

            if (user.status === 'suspended') {
                return `
                    <button class="btn-action btn-reactivate" onclick="reactivateUser('${user.id}')">Reactivate</button>
                    <button class="btn-action btn-reject" onclick="rejectUser('${user.id}')">Delete</button>
                `;
            }

            return '';
        }

        // Action handlers
        async function approveUser(userId) {
            await userAction('approve', userId, 'User approved');
        }

        async function rejectUser(userId) {
            if (!confirm('Are you sure you want to reject/delete this user?')) return;
            await userAction('reject', userId, 'User rejected');
        }

        async function suspendUser(userId) {
            if (!confirm('Are you sure you want to suspend this user?')) return;
            await userAction('suspend', userId, 'User suspended');
        }

        async function reactivateUser(userId) {
            await userAction('reactivate', userId, 'User reactivated');
        }

        async function userAction(action, userId, successMsg) {
            try {
                const token = localStorage.getItem('tb_token');
                const res = await fetch(`${API_BASE}/admin/${action}/${userId}`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Action failed');
                }

                showToast(successMsg, 'success');
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // Tab filtering
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderUsers();
            });
        });

        // Helpers
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            localStorage.removeItem('tb_token');
            localStorage.removeItem('tb_user');
            window.location.href = '/login.html';
        }

        // Init
        (async function init() {
            const authed = await checkAuth();
            if (authed) {
                loadUsers();
            }
        })();
    </script>
</body>

</html>
